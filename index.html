<!DOCTYPE html>
<html lang="en" class=""> <!-- Start without 'dark', JS will add it based on preference/default -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Context - Folder Compiler</title>
    <!-- Tailwind CSS via Play CDN -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio"></script>
    <script>
        // Tailwind Dark Mode Configuration & Custom Theme Colors
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: { // Using the previously refined Zinc palette for dark mode
                        'primary': { light: '#3b82f6', DEFAULT: '#3b82f6', dark: '#60a5fa' },
                        'secondary': { light: '#10b981', DEFAULT: '#10b981', dark: '#34d399' },
                        'background': { light: '#f9fafb', DEFAULT: '#f9fafb', dark: '#18181b' },
                        'surface': { light: '#ffffff', DEFAULT: '#ffffff', dark: '#27272a' },
                        'text-primary': { light: '#1f2937', DEFAULT: '#1f2937', dark: '#e4e4e7' },
                        'text-secondary': { light: '#6b7280', DEFAULT: '#6b7280', dark: '#a1a1aa' },
                        'border': { light: '#e5e7eb', DEFAULT: '#e5e7eb', dark: '#3f3f46' },
                        'error': { light: '#ef4444', DEFAULT: '#ef4444', dark: '#f87171' },
                        'error-surface': { light: '#fee2e2', DEFAULT: '#fee2e2', dark: '#3f1212' }
                    },
                    transitionTimingFunction: { 'smooth': 'cubic-bezier(0.4, 0, 0.2, 1)' },
                    keyframes: {
                        'fade-scale-in': {
                            '0%': { opacity: '0', transform: 'scale(0.95) translateY(10px)' },
                            '100%': { opacity: '1', transform: 'scale(1) translateY(0)' },
                        }
                    },
                    animation: { 'fade-scale-in': 'fade-scale-in 0.3s ease-out forwards' }
                }
            }
        }

        // --- Theme Handling (Default Dark) ---
        const Theme = { LIGHT: 'light', DARK: 'dark' };
        let currentTheme = localStorage.getItem('theme') || Theme.DARK; // Default DARK

        function applyTheme(theme, isInitial = false) { /* ... unchanged ... */
            const htmlEl = document.documentElement;
            if (theme === Theme.DARK) htmlEl.classList.add('dark');
            else htmlEl.classList.remove('dark');
            if (!isInitial) document.body.classList.add('transition-colors', 'duration-300', 'ease-smooth');
            localStorage.setItem('theme', theme);
            currentTheme = theme;
            updateThemeToggleButtonVisuals();
         }
        function toggleTheme() { /* ... unchanged ... */ applyTheme(currentTheme === Theme.LIGHT ? Theme.DARK : Theme.LIGHT); }
        function updateThemeToggleButtonVisuals() { /* ... unchanged ... */
            const btn = document.getElementById('theme-toggle-btn'); const iconLight = document.getElementById('theme-icon-light'); const iconDark = document.getElementById('theme-icon-dark'); if (!btn || !iconLight || !iconDark) return;
            if (currentTheme === Theme.DARK) { iconLight.classList.add('hidden'); iconDark.classList.remove('hidden'); btn.setAttribute('aria-label', 'Switch to light mode'); }
            else { iconLight.classList.remove('hidden'); iconDark.classList.add('hidden'); btn.setAttribute('aria-label', 'Switch to dark mode'); }
        }
        applyTheme(currentTheme, true);
        document.addEventListener('DOMContentLoaded', updateThemeToggleButtonVisuals);

    </script>

    <style type="text/tailwindcss">
        body { @apply bg-background dark:bg-background-dark text-text-primary dark:text-text-primary-dark min-h-screen flex flex-col items-center p-4 sm:p-8; }
        .spinner { @apply border-4 border-transparent border-l-primary dark:border-l-primary-dark border-t-primary dark:border-t-primary-dark rounded-full w-8 h-8 animate-spin; }
        #drop-zone { @apply transition-all duration-300 ease-smooth; }
        #drop-zone.dragover { @apply border-primary dark:border-primary-dark bg-primary/5 dark:bg-primary-dark/10 ring-2 ring-primary/50 dark:ring-primary-dark/50 ring-offset-2 ring-offset-background dark:ring-offset-background-dark shadow-xl scale-[1.03]; }
        button:focus-visible, a:focus-visible { @apply ring-2 ring-offset-2 ring-primary dark:ring-primary-dark ring-offset-background dark:ring-offset-background-dark outline-none rounded-md; }
        #theme-toggle-btn:focus-visible { @apply rounded-full; }
        #drop-zone:focus-visible { @apply ring-2 ring-primary dark:ring-primary-dark border-primary dark:border-primary-dark; }
        .folder-card { @apply transition-all duration-300 ease-smooth; }
        .folder-card:hover { @apply shadow-lg dark:shadow-primary/10 -translate-y-1; }
        .error-card:hover { @apply shadow-lg dark:shadow-error/10 -translate-y-1; }
        .download-btn, .disabled-btn { @apply h-[40px] flex items-center justify-center; }
        .fade-transition { @apply transition-opacity duration-300 ease-smooth; }

        /* Footer link specific hover */
        .footer-link {
            @apply inline-flex items-center font-medium text-primary dark:text-primary-dark transition-colors duration-200 ease-smooth;
        }
        .footer-link:hover {
            /* Define hover style directly on the link */
            @apply underline text-opacity-80 dark:text-opacity-80;
        }
        .footer-text-wrapper:hover .footer-link {
             /* Optional: Additional effect on link when wrapper is hovered */
             /* Example: Slightly brighter text */
             /* @apply text-primary-light dark:text-primary-dark; */
        }

    </style>
</head>
<body>

    <!-- Theme Toggle Button -->
    <button id="theme-toggle-btn" onclick="toggleTheme()" aria-label="Switch theme" class="fixed top-4 right-4 z-50 p-2.5 rounded-full bg-surface dark:bg-surface-dark text-text-secondary dark:text-text-secondary-dark shadow-md hover:shadow-lg hover:text-primary dark:hover:text-primary-dark hover:scale-110 active:scale-95 transform border border-border dark:border-border-dark transition-all duration-200 ease-smooth">
        <svg id="theme-icon-light" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"> <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /> </svg>
        <svg id="theme-icon-dark" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"> <path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /> </svg>
    </button>

    <header class="text-center mb-10 mt-10 max-w-3xl">
        <h1 class="text-4xl sm:text-5xl font-bold mb-3 bg-gradient-to-r from-primary to-secondary dark:from-primary-dark dark:to-secondary-dark text-transparent bg-clip-text">
            Context
        </h1>
        <p class="text-lg sm:text-xl text-text-secondary dark:text-text-secondary-dark">
            Drag & drop codebase folders. Get a single text file for your AI context window.
        </p>
    </header>

    <main class="w-full max-w-5xl flex flex-col items-center flex-grow">
        <!-- Drop Zone -->
        <div id="drop-zone" tabindex="0" aria-label="Drop zone for folders" class="w-full max-w-2xl border-2 border-dashed border-border dark:border-border-dark rounded-xl p-8 sm:p-12 text-center bg-surface dark:bg-surface-dark cursor-pointer mb-10 shadow-sm hover:border-primary dark:hover:border-primary-dark focus:border-primary dark:focus:border-primary-dark focus:outline-none">
            <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto mb-5 h-14 w-14 text-text-secondary dark:text-text-secondary-dark opacity-50 group-hover:opacity-75 transition-opacity" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1"> <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m.75 12l3 3m0 0l3-3m-3 3v-6m-1.5-1.5H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9h-1.5" /> </svg>
            <p class="font-semibold text-xl text-text-primary dark:text-text-primary-dark mb-2">Drag & Drop Folders Here</p>
            <p class="text-sm text-text-secondary dark:text-text-secondary-dark">Code files (PHP, JS, CSS, etc.) will be compiled. Images & media ignored.</p>
        </div>

        <!-- Processing Indicator -->
        <div id="processing-indicator" class="fade-transition hidden opacity-0 items-center justify-center space-x-3 my-6">
            <div class="spinner"></div>
            <p class="text-lg font-medium text-primary dark:text-primary-dark">Processing...</p>
        </div>

        <!-- Output Area - Grid for Cards -->
        <div id="output-area" class="w-full grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5 sm:gap-6">
            <!-- Folder cards appear here and STAY -->
        </div>
    </main>

    <!-- Enhanced Footer - No Border, Wrapper Hover -->
    <footer class="w-full max-w-5xl text-center mt-16 mb-6 pt-6">
        <p class="footer-text-wrapper group text-sm text-text-secondary dark:text-text-secondary-dark inline-flex items-center transition-transform duration-200 ease-smooth hover:scale-[1.03]">
            Built byÂ 
            <a href="https://github.com/andermendz" target="_blank" rel="noopener noreferrer"
               class="footer-link focus:underline">
                <!-- Simple GitHub Icon -->
                <svg class="w-4 h-4 mr-1.5 group-hover:text-primary dark:group-hover:text-primary-dark transition-colors duration-200 ease-smooth" fill="currentColor" viewBox="0 0 16 16" aria-hidden="true">
                  <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"/>
                </svg>
                andermendz
            </a>
        </p>
    </footer>

    <script>
        const dropZone = document.getElementById('drop-zone');
        const processingIndicator = document.getElementById('processing-indicator');
        const outputArea = document.getElementById('output-area');
        const TEXT_EXTENSIONS = new Set([ /* Keep the extensive list */
            '.txt', '.js', '.json', '.php', '.css', '.html', '.htm', '.xml', '.svg',
            '.md', '.markdown', '.yaml', '.yml', '.ini', '.cfg', '.conf', '.sh', '.bash',
            '.py', '.java', '.c', '.h', '.cpp', '.hpp', '.cs', '.go', '.rs', '.rb',
            '.ts', '.tsx', '.jsx', '.vue', '.sql', '.env', '.log', '.gitignore', '.gitattributes',
            '.csv', '.tsv', '.pl', '.pm', '.lua', '.kt', '.kts', '.swift', '.scss', '.less',
            '.styl', '.properties', '.toml', '.bat', '.cmd', '.ps1'
        ]);

        let processingTimeout = null;

        // --- Drag and Drop Handlers ---
        dropZone.addEventListener('dragenter', (event) => { /* ... unchanged ... */ event.preventDefault(); dropZone.classList.add('dragover'); });
        dropZone.addEventListener('dragover', (event) => event.preventDefault());
        dropZone.addEventListener('dragleave', (event) => { /* ... unchanged ... */ event.preventDefault(); if (!dropZone.contains(event.relatedTarget)) { dropZone.classList.remove('dragover'); } });
        dropZone.addEventListener('drop', (event) => { /* ... unchanged drop logic ... */
            event.preventDefault();
            dropZone.classList.remove('dragover');
            showProcessingIndicator();
            outputArea.innerHTML = ''; // Clear previous results

            const items = event.dataTransfer.items;
            const folderPromises = [];

            if (items) {
                 Array.from(items).forEach(item => {
                    const entry = item.webkitGetAsEntry();
                    if (entry?.isDirectory) { folderPromises.push(processFolder(entry)); }
                    else if (entry) { addErrorCard('Skipped Item', `"${entry.name}" is not a folder.`); }
                    else if (items.length > 0) { addErrorCard('Skipped Item', 'Could not access one dropped item.'); }
                 });
            } else { addErrorCard('Browser Issue', "Could not access dropped items.", true); hideProcessingIndicator(); return; }

            if (folderPromises.length === 0 && outputArea.childElementCount === 0 && items?.length > 0) { addErrorCard('No Folders Found', "Please drag and drop folders.", true); hideProcessingIndicator(); return; }
            else if (folderPromises.length === 0) { hideProcessingIndicator(); return; }

            Promise.allSettled(folderPromises).then(results => {
                hideProcessingIndicator(); let hasSuccess = false;
                results.forEach(result => {
                    if (result.status === 'fulfilled') {
                        const { folderName, outputText, fileCount } = result.value;
                        if (fileCount === 0) createFolderCard(folderName, null, 0, true);
                        else { createFolderCard(folderName, outputText, fileCount); hasSuccess = true; }
                    } else { const folderName = result.reason?.folderName || 'Unknown'; addErrorCard(`Error: ${folderName}`, result.reason?.message || 'Failed.'); }
                });
                if (hasSuccess) flashDropZoneBorder('border-secondary', 'dark:border-secondary-dark');
                else if (outputArea.childElementCount > 0) flashDropZoneBorder('border-error', 'dark:border-error-dark');
            });
        });

        // --- UI Update Functions ---
        function showProcessingIndicator() { /* ... unchanged fade-in logic ... */ clearTimeout(processingTimeout); processingIndicator.classList.remove('hidden'); requestAnimationFrame(() => { processingIndicator.classList.add('flex'); processingIndicator.classList.remove('opacity-0'); }); }
        function hideProcessingIndicator() { /* ... unchanged fade-out logic ... */ processingIndicator.classList.add('opacity-0'); processingTimeout = setTimeout(() => { processingIndicator.classList.add('hidden'); processingIndicator.classList.remove('flex'); }, 300); }
        function flashDropZoneBorder(lightClass, darkClass) { /* ... unchanged flash logic ... */ dropZone.classList.add(lightClass, darkClass, 'border-solid'); dropZone.classList.remove('border-dashed'); setTimeout(() => { dropZone.classList.remove(lightClass, darkClass, 'border-solid'); dropZone.classList.add('border-dashed'); }, 800); }

        // --- Core Folder Processing Logic (Unchanged) ---
        async function processFolder(directoryEntry) { /* ... unchanged ... */
            const outputLines = []; const folderName = directoryEntry.name; let fileCount = 0;
            try {
                await traverseDirectory(directoryEntry, '');
                outputLines.sort((a, b) => a.path.localeCompare(b.path));
                const outputText = outputLines.map(item => `// ${folderName}${item.path ? '/' + item.path : ''}\n${item.content}`).join('\n\n---\n\n');
                fileCount = outputLines.filter(line => !line.content.startsWith("// Error reading file:")).length;
                return { folderName, outputText, fileCount };
            } catch (error) { console.error(`Error: ${folderName}:`, error); error.folderName = folderName; throw error; }
            async function traverseDirectory(entry, currentRelativePath) { /* ... unchanged ... */
                if (entry.isFile) { await processFileEntry(entry, currentRelativePath ? `${currentRelativePath}/${entry.name}` : entry.name); }
                else if (entry.isDirectory) {
                    const reader = entry.createReader(); let entries = []; let readEntriesBatch;
                    do { readEntriesBatch = await readEntriesFromReader(reader); entries = entries.concat(readEntriesBatch); } while (readEntriesBatch.length > 0);
                    const dirPath = currentRelativePath ? `${currentRelativePath}/${entry.name}` : entry.name;
                    const promises = entries.map(subEntry => traverseDirectory(subEntry, dirPath)); await Promise.all(promises);
                }
            }
            async function processFileEntry(fileEntry, relativeFilePath) { /* ... unchanged ... */
                try {
                    const file = await getFileFromFileEntry(fileEntry);
                    if (isTextFile(file.name)) { const content = await readFileContent(file); outputLines.push({ path: relativeFilePath, content: content }); }
                } catch (error) { console.warn(`Read Err: ${folderName}/${relativeFilePath}`, error); outputLines.push({ path: relativeFilePath, content: `// Error reading file: ${error.message}` }); }
            }
        }

        // --- Promise Wrappers & Utilities (Unchanged) ---
        function readEntriesFromReader(directoryReader) { /* ... same ... */ return new Promise((resolve, reject) => { directoryReader.readEntries(resolve, reject); }); }
        function getFileFromFileEntry(fileEntry) { /* ... same ... */ return new Promise((resolve, reject) => { fileEntry.file(resolve, reject); }); }
        function readFileContent(file) { /* ... same ... */ return new Promise((resolve, reject) => { const reader = new FileReader(); reader.onload = (event) => resolve(event.target.result); reader.onerror = (event) => reject(new Error(`Read Err: ${event.target.error?.message || 'Unknown'}`)); reader.readAsText(file); }); }
        function isTextFile(filename) { /* ... same ... */ if (!filename || !filename.includes('.')) return false; const extension = filename.substring(filename.lastIndexOf('.')).toLowerCase(); return TEXT_EXTENSIONS.has(extension); }

        // --- Card Creation Functions (NO FADE-OUT) ---

        /** Creates card, appends it, DOES NOT remove automatically */
        function createFolderCard(folderName, textContent, fileCount, isEmpty = false) {
            const card = document.createElement('div');
            card.className = 'folder-card bg-surface dark:bg-surface-dark rounded-lg shadow-md p-5 border border-border dark:border-border-dark flex flex-col justify-between min-h-[180px] relative overflow-hidden animate-fade-scale-in'; // Removed transition here as it's on base class

            let downloadLink = null; let downloadFileName = '';
            if (textContent && !isEmpty) { /* ... blob creation ... */
                 const blob = new Blob([textContent], { type: 'text/plain;charset=utf-8' });
                 downloadLink = URL.createObjectURL(blob);
                 const safeFolderName = folderName.replace(/[^a-z0-9_.-]/gi, '_');
                 downloadFileName = `context_${safeFolderName}.txt`;
            }
            card.innerHTML = `
                <div> <div class="flex items-center mb-3 space-x-3"> <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-primary dark:text-primary-dark flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"> <path stroke-linecap="round" stroke-linejoin="round" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" /> </svg> <h3 class="text-lg font-semibold text-text-primary dark:text-text-primary-dark truncate" title="${folderName}">${folderName}</h3> </div> <p class="text-sm text-text-secondary dark:text-text-secondary-dark mb-4"> ${isEmpty ? 'No text files found.' : `${fileCount} text file${fileCount !== 1 ? 's' : ''} compiled.`} </p> </div>
                <div class="mt-auto">
                ${downloadLink ? `<a href="${downloadLink}" download="${downloadFileName}" class="download-btn w-full px-4 py-2 bg-secondary dark:bg-secondary-dark text-white font-medium rounded-md shadow-sm hover:bg-opacity-90 dark:hover:bg-opacity-90 active:scale-[0.97] active:bg-opacity-100 transition-all duration-150 ease-in-out text-sm"> <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"> <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /> </svg> Download Context </a>`
                 : `<span class="disabled-btn w-full px-4 py-2 bg-gray-200 dark:bg-zinc-700 text-text-secondary dark:text-text-secondary-dark font-medium rounded-md text-sm cursor-not-allowed opacity-70"> <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"> <path stroke-linecap="round" stroke-linejoin="round" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" /> </svg> No Content </span>` }
                </div> `;
            outputArea.appendChild(card);
            if (downloadLink) { const linkElement = card.querySelector('a.download-btn'); linkElement.addEventListener('click', () => { setTimeout(() => URL.revokeObjectURL(downloadLink), 500); }); }
        }

        /** Adds error card, DOES NOT remove automatically */
        function addErrorCard(title, message, isMajor = false) {
             const card = document.createElement('div');
             card.className = `error-card folder-card bg-error-surface/50 dark:bg-error-surface dark:bg-opacity-40 rounded-lg shadow-md p-5 border border-error/50 dark:border-error/30 flex flex-col justify-between min-h-[180px] relative overflow-hidden animate-fade-scale-in ${isMajor ? 'md:col-span-2 lg:col-span-3' : ''}`; // Removed transition here as it's on base class
             card.innerHTML = `
                 <div> <div class="flex items-center mb-3 space-x-3"> <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-error dark:text-error-dark flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"> <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" /> </svg> <h3 class="text-lg font-semibold text-error dark:text-error-dark truncate" title="${title}">${title}</h3> </div> <p class="text-sm text-error/90 dark:text-error-dark/90 mb-4"> ${message} </p> </div>
                 <div class="mt-auto h-[40px]"></div> `;
             outputArea.appendChild(card);
        }

    </script>

</body>
</html>